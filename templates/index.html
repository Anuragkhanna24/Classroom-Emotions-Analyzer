
<!-- <script>
  // Check if user is logged in
  if(!sessionStorage.getItem('userRole') || sessionStorage.getItem('userRole') !== 'faculty') {
      window.location.href = 'login.html';
  }
</script> -->
<!DOCTYPE html>
<html lang="en">
<head>

  <!-- <script>
    // Check if coming from login
    if(!document.referrer.includes('login.html') && !sessionStorage.getItem('loggedIn')) {
        window.location.href = '../login.html';
    } else {
        sessionStorage.setItem('loggedIn', 'true');
    }
</script>


<script>
  // Modify your existing analysis function to store results
  function processAnalysis(results) {
      // Store results for the results page
      sessionStorage.setItem('analysisResults', JSON.stringify(results));
      
      // Redirect to results page
      window.location.href = 'result.html';
  }
  
  // Make sure your existing analysis calls processAnalysis() with results
</script> -->


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Emotion Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    .container {
      padding-top: 3rem;
      padding-bottom: 3rem;
    }
    
    .card {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(50, 50, 93, 0.15), 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      background: linear-gradient(90deg, #4776E6 0%, #8E54E9 100%);
      border-bottom: none;
      padding: 1.5rem;
    }
    
    .card-header h2 {
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    .upload-area {
      border: 2px dashed #8E54E9;
      border-radius: 12px;
      padding: 60px 20px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      background-color: rgba(142, 84, 233, 0.03);
    }
    
    .upload-area:hover, .upload-area.dragover {
      border-color: #4776E6;
      background-color: rgba(71, 118, 230, 0.08);
      transform: scale(1.01);
    }
    
    .upload-area svg {
      fill: #8E54E9;
      transition: transform 0.5s ease;
    }
    
    .upload-area:hover svg {
      transform: translateY(-5px);
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      display: none;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .progress {
      display: none;
      margin: 20px 0;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .btn {
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 500;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, #4776E6 0%, #8E54E9 100%);
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(90deg, #3d68d8 0%, #7c46d4 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(71, 118, 230, 0.4);
    }
    
    .btn-secondary {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      color: #444;
    }
    
    .btn-secondary:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .btn-outline-secondary {
      border-color: #8E54E9;
      color: #8E54E9;
    }
    
    .btn-outline-secondary:hover {
      background-color: #8E54E9;
      color: white;
    }
    
    .card-footer {
      background-color: rgba(142, 84, 233, 0.03);
      border-top: 1px solid rgba(142, 84, 233, 0.1);
      padding: 1rem 2rem;
    }
    
    .text-muted {
      color: #6c757d !important;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(142, 84, 233, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(142, 84, 233, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(142, 84, 233, 0);
      }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="card shadow animate__animated animate__fadeIn">
          <div class="card-header">
            <h2 class="mb-0 fs-4 animate__animated animate__fadeInDown">Classroom Emotion Analysis</h2>
          </div>
          <div class="card-body">
            <p class="card-text animate__animated animate__fadeIn animate__delay-1s">
              Upload a classroom image to analyze student emotions and engagement levels.
            </p>
            
            <div class="upload-area animate__animated animate__fadeIn animate__delay-1s" id="uploadArea">
              <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-cloud-upload mb-3" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H10a.5.5 0 0 1 0-1h2.688C13.979 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12H6a.5.5 0 0 1 0 1H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
              </svg>
              <h5>Drop your image here or click to browse</h5>
              <p class="text-muted">Supported formats: JPG, PNG</p>
            </div>
            
            <img id="previewImage" class="preview-image animate__animated animate__fadeIn" alt="Image preview" />
            
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            
            <form id="uploadForm" class="mt-3 animate__animated animate__fadeIn animate__delay-2s">
              <input type="file" id="fileInput" name="file" accept="image/*" class="d-none" required />
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" id="browseButton" class="btn btn-secondary">Browse Files</button>
                <button type="submit" id="uploadButton" class="btn btn-primary" disabled>Analyze Image</button>
              </div>
            </form>
          </div>
          <div class="card-footer text-muted">
            <div class="d-flex justify-content-between">
              <a href="/history" class="btn btn-outline-secondary btn-sm">View History</a>
              <span>Classroom Emotion Analysis Tool</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const uploadArea = document.getElementById("uploadArea");
    const previewImage = document.getElementById("previewImage");
    const progressBar = document.querySelector(".progress");
    const progressBarInner = document.querySelector(".progress-bar");
    const browseButton = document.getElementById("browseButton");
    const uploadButton = document.getElementById("uploadButton");
    
    // Event listeners for drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      uploadArea.classList.add('dragover');
      uploadArea.classList.add('animate__pulse');
      setTimeout(() => {
        uploadArea.classList.remove('animate__pulse');
      }, 1000);
    }
    
    function unhighlight() {
      uploadArea.classList.remove('dragover');
    }
    
    // Handle file drop
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        fileInput.files = files;
        handleFiles(files);
      }
    }
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
      handleFiles(this.files);
    });
    
    // Preview and validate files
    function handleFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      
      // Validate file type
      if (!file.type.match('image.*')) {
        alert('Please select an image file (JPG or PNG)');
        fileInput.value = '';
        return;
      }
      
      // Preview image
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.classList.remove('animate__fadeIn');
        void previewImage.offsetWidth; // Trigger reflow to restart animation
        previewImage.classList.add('animate__fadeIn');
        previewImage.style.display = 'block';
        previewImage.src = e.target.result;
        uploadButton.disabled = false;
        uploadButton.classList.add('animate__pulse');
        setTimeout(() => {
          uploadButton.classList.remove('animate__pulse');
        }, 1000);
      };
      reader.readAsDataURL(file);
    }
    
    // Click handlers
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
    
    browseButton.addEventListener('click', function() {
      fileInput.click();
    });
    
    // Add pulse animation effect to buttons on hover
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
      button.addEventListener('mouseenter', function() {
        this.style.animation = 'pulse 1s';
      });
      button.addEventListener('mouseleave', function() {
        this.style.animation = '';
      });
    });
    
    // Form submission
    uploadForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select an image file first');
        return;
      }
      
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      
      // Show progress bar with animation
      progressBar.style.display = 'flex';
      progressBar.classList.add('animate__fadeIn');
      progressBarInner.style.width = '0%';
      
      // Disable buttons during upload
      uploadButton.disabled = true;
      browseButton.disabled = true;
      
      try {
        // Simulate progress (since fetch doesn't provide progress events)
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 5;
          if (progress > 90) clearInterval(progressInterval);
          progressBarInner.style.width = progress + '%';
        }, 100);
        
        const response = await fetch("/upload/", {
          method: "POST",
          body: formData,
        });
        
        clearInterval(progressInterval);
        progressBarInner.style.width = '100%';
        
        const data = await response.json();
        
        if (data.error) {
          alert('Error: ' + data.error);
        } else if (data.success && data.analysis_id) {
          // Add a success animation before redirect
          document.querySelector('.card').classList.add('animate__pulse');
          setTimeout(() => {
            // Redirect to results page
            window.location.href = `/result/${data.analysis_id}`;
          }, 1000);
        }
      } catch (err) {
        console.error(err);
        alert('Upload failed! Please try again.');
      } finally {
        // Re-enable buttons
        uploadButton.disabled = false;
        browseButton.disabled = false;
      }
    });
    
    // Add animation to page load
    document.addEventListener('DOMContentLoaded', function() {
      // Stagger animations
      const card = document.querySelector('.card');
      setTimeout(() => {
        card.classList.add('animate__pulse');
      }, 1500);
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>